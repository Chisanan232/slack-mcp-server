---
id: url-verification
title: URL Verification
sidebar_position: 2
---

# URL Verification

The Slack webhook server automatically handles URL verification challenges sent by Slack when configuring your webhook endpoint. This is a required step in the Slack Events API setup process to verify that your endpoint can receive and respond to Slack requests.

## Overview

When you configure a webhook URL in your Slack app's Event Subscriptions settings, Slack sends a URL verification challenge to verify that:

1. **Your endpoint is accessible** from Slack's servers
2. **Your endpoint can process JSON payloads** correctly
3. **Your endpoint responds with the expected format** within the timeout period

The webhook server handles this automatically without any additional configuration required.

## Challenge Request Format

### HTTP Method and Headers
- **Method**: `POST`
- **Path**: `/slack/events`
- **Content-Type**: `application/json`
- **Headers**: Standard Slack signature verification headers

### Request Body
```json
{
  "token": "verification_token_deprecated",
  "challenge": "3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P",
  "type": "url_verification"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `token` | `string` | Legacy verification token (deprecated, not used for verification) |
| `challenge` | `string` | Random challenge string that must be echoed back |
| `type` | `string` | Always `"url_verification"` for challenge requests |

## Challenge Response Format

### Successful Response
```json
{
  "challenge": "3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"
}
```

**HTTP Status**: `200 OK`  
**Content-Type**: `application/json`

### Response Requirements
- **Echo the challenge**: The response must contain the exact challenge string from the request
- **Correct format**: Must be a JSON object with a `challenge` field
- **Timely response**: Must respond within 3 seconds
- **Valid signature**: The request signature must be verified (if signature verification is enabled)

## Verification Process Flow

```mermaid
sequenceDiagram
    participant Slack as Slack Platform
    participant Server as Webhook Server
    participant Handler as Challenge Handler

    Note over Slack: User configures webhook URL
    Slack->>Server: POST /slack/events (Challenge)
    Note over Server: Verify request signature
    Server->>Handler: Parse JSON payload
    Handler->>Handler: Detect type: "url_verification"
    Handler->>Server: Return challenge response
    Server->>Slack: 200 OK + challenge
    Note over Slack: Verification successful
```

## Implementation Details

### Automatic Detection

The webhook server automatically detects URL verification requests using two methods:

#### 1. Pydantic Model Detection (Primary)
```python
if isinstance(slack_event_model, UrlVerificationModel):
    _LOG.info("Handling URL verification challenge")
    return JSONResponse(content={"challenge": slack_event_model.challenge})
```

#### 2. Fallback Dictionary Detection
```python
elif "challenge" in slack_event_dict:
    _LOG.info("Handling URL verification challenge (fallback)")
    return JSONResponse(content={"challenge": slack_event_dict["challenge"]})
```

### Pydantic Model

The server uses a Pydantic model for type-safe challenge handling:

```python
class UrlVerificationModel(BaseModel):
    """Pydantic model for Slack URL verification challenge."""
    
    type: str = Field(..., pattern="url_verification")
    challenge: str
    token: str
```

## Configuration Steps

### 1. Start the Webhook Server

```bash
# Start the server on default port 3000
python -m slack_mcp.webhook --host 0.0.0.0 --port 3000
```

### 2. Configure Slack App Event Subscriptions

1. **Navigate to your Slack app** at [api.slack.com/apps](https://api.slack.com/apps)
2. **Go to Event Subscriptions** in the left sidebar
3. **Toggle "Enable Events"** to on
4. **Enter your Request URL**:
   - Local development: `https://abc123.ngrok.io/slack/events` (using ngrok)
   - Production: `https://your-domain.com/slack/events`

### 3. Slack Sends Challenge Request

When you save the Request URL, Slack automatically sends a challenge request to verify the endpoint.

### 4. Server Responds Automatically

The webhook server automatically:
- Verifies the request signature (if configured)
- Parses the JSON payload
- Detects the URL verification type
- Returns the challenge string
- Logs the verification process

## Development Setup

### Local Development with ngrok

For local development, use ngrok to expose your local server:

```bash
# Terminal 1: Start the webhook server
python -m slack_mcp.webhook --host 127.0.0.1 --port 3000

# Terminal 2: Expose with ngrok
ngrok http 3000

# Use the HTTPS ngrok URL in Slack
# Example: https://abc123.ngrok.io/slack/events
```

### Environment Variables

Ensure required environment variables are set:

```bash
# Required for signature verification
export SLACK_SIGNING_SECRET="your_signing_secret_here"

# Optional: Bot token (not needed for URL verification, but required for full functionality)
export SLACK_BOT_TOKEN="xoxb-your-bot-token"
```

## Troubleshooting

### Common Issues

#### 1. Verification Failed - Invalid Request Signature

**Error**: "Your URL didn't respond with the expected challenge parameter."

**Causes**:
- Missing or incorrect `SLACK_SIGNING_SECRET`
- Clock skew between server and Slack
- Incorrect signature verification implementation

**Solutions**:
```bash
# Check that signing secret is correctly set
echo $SLACK_SIGNING_SECRET

# Verify the signing secret matches your Slack app
# Go to: Slack App > Basic Information > App Credentials > Signing Secret
```

#### 2. Request Timeout

**Error**: "Your URL didn't respond in time."

**Causes**:
- Server not accessible from the internet
- Server taking too long to respond (>3 seconds)
- Network connectivity issues

**Solutions**:
```bash
# Test server accessibility
curl -X POST https://your-domain.com/slack/events \
  -H "Content-Type: application/json" \
  -d '{"type": "url_verification", "challenge": "test", "token": "test"}'

# Check server response time
time curl -X POST https://your-domain.com/slack/events
```

#### 3. Malformed Response

**Error**: "Your URL returned an error."

**Causes**:
- Server returning HTML instead of JSON
- Missing `challenge` field in response
- Incorrect Content-Type header

**Solutions**:
- Ensure server returns `application/json`
- Verify challenge echoing logic
- Check server logs for errors

### Debugging Tips

#### Enable Debug Logging
```bash
python -m slack_mcp.webhook --log-level DEBUG
```

#### Test Challenge Locally
```bash
# Simulate a challenge request
curl -X POST http://localhost:3000/slack/events \
  -H "Content-Type: application/json" \
  -H "X-Slack-Signature: v0=test" \
  -H "X-Slack-Request-Timestamp: $(date +%s)" \
  -d '{
    "type": "url_verification",
    "challenge": "test_challenge_string",
    "token": "deprecated_token"
  }'

# Expected response:
# {"challenge": "test_challenge_string"}
```

#### Verify Signature Calculation
```python
import hmac
import hashlib
import time

def verify_signature(signing_secret, timestamp, body, signature):
    basestring = f"v0:{timestamp}:{body}"
    expected = f"v0={hmac.new(signing_secret.encode(), basestring.encode(), hashlib.sha256).hexdigest()}"
    return hmac.compare_digest(expected, signature)
```

## Security Considerations

### Signature Verification

Even during URL verification, the server performs signature verification:

1. **Request Headers**: Slack includes `X-Slack-Signature` and `X-Slack-Request-Timestamp`
2. **Verification Process**: Server calculates HMAC-SHA256 and compares signatures
3. **Security**: Prevents unauthorized challenge requests

### Production Recommendations

- **Use HTTPS**: Always use HTTPS endpoints in production
- **Validate Environment**: Ensure signing secret is properly configured
- **Monitor Logs**: Watch for failed verification attempts
- **Rate Limiting**: Implement rate limiting for the endpoint

## Success Indicators

### Slack App Configuration

When URL verification succeeds, you'll see:
- âœ… **Green checkmark** next to your Request URL in Slack app settings
- **"Verified"** status in Event Subscriptions
- Ability to **save your Event Subscriptions configuration**

### Server Logs

Successful verification shows in logs:
```
[INFO] Handling URL verification challenge
```

### Next Steps

After successful URL verification:

1. **Subscribe to Events**: Configure which event types to receive
2. **Set OAuth Scopes**: Ensure your bot has necessary permissions
3. **Install App**: Install the app to your workspace
4. **Test Events**: Trigger events and verify they're received

## Advanced Configuration

### Custom Challenge Handler

If you need custom challenge handling logic:

```python
from slack_mcp.webhook.server import create_slack_app

app = create_slack_app()

@app.post("/custom/slack/events")
async def custom_challenge_handler(request):
    # Custom challenge handling logic
    body = await request.json()
    
    if body.get("type") == "url_verification":
        # Custom verification logic here
        return {"challenge": body["challenge"]}
    
    # Handle other events...
```

### Integration Testing

```python
import pytest
from fastapi.testclient import TestClient
from slack_mcp.webhook.server import create_slack_app

@pytest.fixture
def client():
    app = create_slack_app()
    return TestClient(app)

def test_url_verification(client):
    challenge_data = {
        "type": "url_verification",
        "challenge": "test_challenge",
        "token": "deprecated_token"
    }
    
    response = client.post("/slack/events", json=challenge_data)
    
    assert response.status_code == 200
    assert response.json() == {"challenge": "test_challenge"}
```
