# Event Handlers

The Slack MCP server provides a powerful event handling system that allows you to process Slack events in your applications. This guide shows you how to get started with event handlers and basic configuration.

:::info Architecture Details
For comprehensive technical architecture, queue backend development, and advanced design patterns, see the **[Event Handler & Queue Architecture](/docs/development/architecture/event-handler-queue-architecture)** documentation in the Dev section.
:::

## Getting Started

There are two main ways to create event handlers:

### 1. Class-Based Handlers

Inherit from [`BaseSlackEventHandler`](https://github.com/Chisanan232/slack-mcp-server/blob/master/slack_mcp/webhook/event/handler/base.py#L41-L473) and override methods for specific events:

```python
from slack_mcp.webhook.event.handler.base import BaseSlackEventHandler
from typing import Dict, Any

class MySlackHandler(BaseSlackEventHandler):
    async def on_message(self, event: Dict[str, Any]) -> None:
        """Handle all message events."""
        text = event.get('text', '')
        print(f"Message received: {text}")
    
    async def on_message__channels(self, event: Dict[str, Any]) -> None:
        """Handle message.channels events specifically."""
        channel = event.get('channel')
        text = event.get('text', '')
        print(f"Channel message in {channel}: {text}")
    
    async def on_reaction_added(self, event: Dict[str, Any]) -> None:
        """Handle reaction_added events."""
        reaction = event.get('reaction', '')
        print(f"Reaction added: :{reaction}:")
    
    async def on_unknown(self, event: Dict[str, Any]) -> None:
        """Handle unknown event types."""
        event_type = event.get('type', 'unknown')
        print(f"Unknown event: {event_type}")
```

**Method Naming Convention:**
- `on_{type}()` - Handle events by type (e.g., `on_message`)
- `on_{type}__{subtype}()` - Handle events by type + subtype (e.g., `on_message__channels`)

### 2. Decorator-Based Handlers

Use the [`DecoratorHandler`](https://github.com/Chisanan232/slack-mcp-server/blob/master/slack_mcp/webhook/event/handler/decorator.py) class with decorators:

```python
from slack_mcp.webhook.event.handler.decorator import DecoratorHandler
from slack_mcp.events import SlackEvent
from typing import Dict, Any

# Create handler instance
handler = DecoratorHandler()

# Attribute-style decorators
@handler.message
async def handle_message(event: Dict[str, Any]) -> None:
    text = event.get('text', '')
    print(f"Message: {text}")

@handler.reaction_added
async def handle_reaction(event: Dict[str, Any]) -> None:
    reaction = event.get('reaction', '')
    print(f"Reaction: :{reaction}:")

# Enum-style decorators
@handler(SlackEvent.APP_MENTION)
async def handle_app_mention(event: Dict[str, Any]) -> None:
    text = event.get('text', '')
    print(f"App mentioned: {text}")

# Subtype handling
@handler("message.channels")
async def handle_channel_message(event: Dict[str, Any]) -> None:
    channel = event.get('channel')
    print(f"Channel message in: {channel}")

# Wildcard handler (receives all events)
@handler
async def log_all_events(event: Dict[str, Any]) -> None:
    event_type = event.get('type')
    print(f"Event received: {event_type}")
```

## Complete Setup Example

```python
import asyncio
import logging
from slack_mcp.backends.loader import load_backend
from slack_mcp.webhook.event.consumer import SlackEventConsumer
from slack_mcp.webhook.event.handler.base import BaseSlackEventHandler

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class MyEventHandler(BaseSlackEventHandler):
    async def on_message(self, event):
        logger.info(f"Message: {event.get('text', '')}")
    
    async def on_reaction_added(self, event):
        logger.info(f"Reaction: {event.get('reaction', '')}")

async def main():
    # Load queue backend from environment
    backend = load_backend()  # See: https://github.com/Chisanan232/slack-mcp-server/blob/master/slack_mcp/backends/loader.py#L18-L70
    
    # Create event handler
    handler = MyEventHandler()
    
    # Create and start consumer
    consumer = SlackEventConsumer(backend, handler)
    
    try:
        logger.info("Starting event consumer...")
        await consumer.run()
    except KeyboardInterrupt:
        logger.info("Shutting down...")
        await consumer.shutdown()

if __name__ == "__main__":
    asyncio.run(main())
```

## Basic Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `QUEUE_BACKEND` | Backend type (memory, redis, kafka, etc.) | `memory` |
| `SLACK_EVENTS_TOPIC` | Queue topic for Slack events | `slack_events` |

### Simple Setup

```bash
# For development (default)
export QUEUE_BACKEND=memory

# For production with Redis
export QUEUE_BACKEND=redis
export REDIS_URL=redis://localhost:6379
```

## Error Handling

### Handler-Level Error Handling

```python
@handler.message
async def handle_message_safely(event):
    try:
        # Your processing logic
        process_message(event)
    except Exception as e:
        logger.error(f"Error processing message: {e}")
        # Handle gracefully - don't re-raise
```

### Automatic Error Recovery

The system automatically handles errors to ensure reliability:
- Individual handler failures don't crash the consumer
- Events that fail are logged for debugging
- Processing continues with other handlers and events

## Monitoring

### Health Check

Monitor your event processing:

```bash
curl http://localhost:8000/health
```

### Logging

```python
import logging

# Enable event processing logs
logging.getLogger('slack_mcp.webhook.event').setLevel(logging.INFO)
```

## Troubleshooting

### Common Issues

**Handler not receiving events:**
- Check that the webhook server is running
- Verify Slack app configuration and webhook URL
- Check handler method names match event types

**Events not processing:**
- Check queue backend connection
- Verify environment variables are set correctly
- Look for errors in application logs

**Performance issues:**
- Consider using external queue backends (Redis, Kafka)
- Implement consumer groups for load balancing
- Monitor queue depth and processing latency

## Examples

Complete working examples are available in the [`/examples/event_handler/`](https://github.com/Chisanan232/slack-mcp-server/tree/master/examples/event_handler) directory:

- [`decorator_handler_example.py`](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/decorator_handler_example.py) - Decorator-based handlers
- [`slack_event_handlers.py`](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/slack_event_handlers.py) - Multiple handler patterns  
- [`advanced_slack_handlers.py`](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/advanced_slack_handlers.py) - Production-ready examples

## Complete Setup Workflow

Ready to experience the full Slack event handler system? Follow this end-to-end workflow:

### üöÄ Quick Start (5 minutes)

```bash
cd examples/event_handler

# Interactive setup with guided configuration
python quickstart.py --all

# Or run individual steps
python quickstart.py --setup-env      # Create .env file
python quickstart.py --test-connection  # Test Slack API
python quickstart.py --run-demo        # Run live demo
```

### üìã Manual Setup

If you prefer step-by-step control:

1. **[Setup Guide](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/setup_guide.md)** - Complete Slack app configuration
2. **Environment Configuration** - Set up `.env` file with tokens
3. **Run Examples** - Test with real Slack events

### üéØ Test Real Slack Events

Once configured, test the complete system:

```bash
# Start the complete workflow example
cd examples/event_handler
python complete_workflow_example.py

# In your Slack workspace:
# 1. Send messages in channels where your app is added
# 2. Mention your app: @YourApp hello!
# 3. Add reactions: üëç ‚ù§Ô∏è üéâ
# 4. Create new channels, pin messages, upload files

# Watch the logs to see events being processed in real-time!
```

### üîß Production Deployment

For production use:

1. **External Queue Backend**: Use Redis or Kafka instead of memory
2. **Multiple Consumers**: Scale with consumer groups for load balancing  
3. **Monitoring**: Set up health checks and log aggregation
4. **Error Handling**: Implement dead letter queues and retry logic

See the [Production Setup Guide](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/setup_guide.md#-step-6-production-configuration) for details.

## Next Steps

- **Quick Experience**: Run `python examples/event_handler/quickstart.py --all`
- **Deep Dive**: Review the [Architecture Documentation](/docs/development/architecture/event-handler-queue-architecture)
- **Advanced Patterns**: Explore the [example scripts](https://github.com/Chisanan232/slack-mcp-server/tree/master/examples/event_handler)
- **Production**: Follow the [setup guide](https://github.com/Chisanan232/slack-mcp-server/blob/master/examples/event_handler/setup_guide.md) for deployment
